<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Jailex HUD</title>

<style>
  body {
    margin: 0;
    padding: 0;
    background: radial-gradient(circle at center, #02030a 0%, #000000 80%);
    color: #f5f5f5;
    font-family: system-ui, sans-serif;
    overflow: hidden;
  }

  .app-container {
    display: flex;
    height: 100vh;
  }

  .sidebar {
    width: 220px;
    background: rgba(5,5,15,0.95);
    border-right: 1px solid rgba(255,255,255,0.15);
    box-shadow: 0 0 20px rgba(0,0,0,0.8);
    display: flex;
    flex-direction: column;
    padding: 16px 10px;
  }

  .sidebar-title {
    font-weight: 700;
    font-size: 18px;
    margin-bottom: 4px;
  }

  .sidebar-sub {
    font-size: 12px;
    opacity: 0.7;
    margin-bottom: 16px;
  }

  .tab-button {
    width: 100%;
    text-align: left;
    padding: 10px 12px;
    margin-bottom: 8px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.15);
    background: rgba(10,10,20,0.9);
    color: #f5f5f5;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    box-shadow:
      0 0 10px rgba(255,122,24,0.25),
      inset 0 0 4px rgba(0,200,255,0.2);
    transition: 0.2s ease;
  }

  .tab-button:hover {
    box-shadow:
      0 0 16px rgba(255,122,24,0.6),
      inset 0 0 8px rgba(0,200,255,0.5);
    transform: translateY(-1px);
  }

  .tab-button.active {
    background: linear-gradient(135deg, rgba(255,122,24,0.9), rgba(0,200,255,0.7));
    box-shadow:
      0 0 20px rgba(255,122,24,0.9),
      0 0 14px rgba(0,200,255,0.8);
    border-color: rgba(255,255,255,0.6);
  }

  .version-tag {
    margin-top: auto;
    font-size: 12px;
    opacity: 0.7;
    text-align: center;
  }

  .main {
    flex: 1;
    overflow-y: auto;
    padding: 16px 20px 40px 20px;
  }

  .panel {
    backdrop-filter: blur(14px);
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 12px;
    padding: 16px;
    margin: 10px auto 20px auto;
    width: 100%;
    max-width: 900px;
    box-shadow:
      0 0 20px rgba(255,122,24,0.4),
      0 0 10px rgba(0,200,255,0.3);
    transition: 0.3s ease;
  }

  .panel:hover {
    box-shadow:
      0 0 30px rgba(255,122,24,0.6),
      0 0 20px rgba(0,200,255,0.5);
  }

  .panel h2 {
    margin-top: 0;
    padding-bottom: 6px;
    border-bottom: 2px solid rgba(255,122,24,0.6);
    text-shadow: 0 0 8px #ff7a18;
  }

  button {
    padding: 10px 16px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.2);
    background: rgba(10,10,20,0.8);
    color: #fff;
    cursor: pointer;
    font-weight: 600;
    margin-right: 8px;
    margin-top: 6px;
    transition: 0.25s ease;
    box-shadow:
      0 0 10px rgba(255,122,24,0.4),
      inset 0 0 6px rgba(0,200,255,0.3);
  }

  button:hover {
    box-shadow:
      0 0 18px rgba(255,122,24,0.8),
      inset 0 0 10px rgba(0,200,255,0.6);
    transform: translateY(-2px);
  }

  input[type=range] {
    width: 100%;
    margin-top: 6px;
    accent-color: #ff7a18;
  }

  input[type=text],
  input[type=number],
  input[type=password],
  select {
    width: 100%;
    padding: 6px 8px;
    margin-top: 6px;
    border-radius: 6px;
    border: 1px solid rgba(255,255,255,0.25);
    background: rgba(5,5,10,0.9);
    color: #f5f5f5;
    box-sizing: border-box;
  }

  #chatLog {
    max-height: 300px;
    overflow-y: auto;
    padding-right: 10px;
  }

  .chat-line {
    margin-bottom: 6px;
    font-size: 14px;
    animation: holoSlide 0.35s ease;
  }

  @keyframes holoSlide {
    0% { opacity: 0; transform: translateX(-12px); }
    60% { opacity: 0.6; }
    100% { opacity: 1; transform: translateX(0); }
  }

  .timer-item {
    margin-bottom: 10px;
    padding: 8px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.25);
    background: rgba(5,5,10,0.8);
    font-size: 13px;
  }

  .timer-meta {
    opacity: 0.8;
    font-size: 12px;
  }

  .tab-panel {
    display: none;
  }

  .tab-panel.active {
    display: block;
  }

  .status-pill {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 999px;
    font-size: 11px;
    margin-left: 6px;
  }

  .status-on {
    background: rgba(83,252,24,0.15);
    color: #53fc18;
    border: 1px solid rgba(83,252,24,0.6);
  }

  .status-off {
    background: rgba(255,122,24,0.15);
    color: #ff7a18;
    border: 1px solid rgba(255,122,24,0.6);
  }

  .hint {
    font-size: 11px;
    opacity: 0.75;
    margin-top: 4px;
  }

  .keyword-item {
    margin-bottom: 10px;
    padding: 8px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.25);
    background: rgba(5,5,10,0.8);
    font-size: 13px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .keyword-item .keyword-text {
    color: #ff7a18;
    font-weight: 600;
  }

  .keyword-item .keyword-meta {
    font-size: 11px;
    opacity: 0.7;
  }

  .keyword-item .keyword-actions {
    display: flex;
    gap: 6px;
  }

  .keyword-item button {
    padding: 4px 10px;
    font-size: 12px;
    margin: 0;
  }

  .keyword-toggle-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 8px;
  }

  .keyword-toggle-row label {
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
</style>
</head>
<body>

<div class="app-container">
  <div class="sidebar">
    <div class="sidebar-title">Jailex HUD</div>
    <div class="sidebar-sub">Control Deck</div>

    <button class="tab-button active" data-target="tab-playback" data-testid="tab-playback-btn">Playback</button>
    <button class="tab-button" data-target="tab-voices" data-testid="tab-voices-btn">Voices</button>
    <button class="tab-button" data-target="tab-chat" data-testid="tab-chat-btn">Chat</button>
    <button class="tab-button" data-target="tab-keywords" data-testid="tab-keywords-btn">Keywords</button>
    <button class="tab-button" data-target="tab-timers" data-testid="tab-timers-btn">Timers</button>
    <button class="tab-button" data-target="tab-connections" data-testid="tab-connections-btn">Connections</button>

    <div class="version-tag">
      Version 1.3.0 (Keywords Filter)
    </div>
  </div>

  <div class="main">
    <!-- PLAYBACK TAB -->
    <div id="tab-playback" class="tab-panel active">
      <div class="panel">
        <h2>Playback Control</h2>
        <button id="enableAudioBtn" data-testid="enable-audio-btn">Enable Audio</button>
        <button id="playPauseBtn" data-testid="play-pause-btn">Pause</button>
        <button id="muteBtn" data-testid="mute-btn">Mute</button>
        <button id="testTtsBtn" data-testid="test-tts-btn">TEST TTS</button>
        <button id="testTimerBtn" data-testid="test-timer-btn">TEST TIMER</button>

        <div style="margin-top:12px">
          <label>
            <input type="checkbox" id="readUsername" checked data-testid="read-username-checkbox" />
            Read username before message
          </label>
        </div>

        <p style="opacity:0.8;font-size:14px;margin-top:10px">
          Queue: <span id="queueLen" data-testid="queue-length">0</span>
          &nbsp;|&nbsp;
          Speaking: <span id="speakingNow" data-testid="speaking-now">None</span>
        </p>
      </div>
    </div>

    <!-- VOICES TAB -->
    <div id="tab-voices" class="tab-panel">
      <div class="panel">
        <h2>Voice Settings</h2>

        <label>TTS Engine</label>
        <select id="ttsEngineSelect" data-testid="tts-engine-select">
          <option value="browser">Browser TTS</option>
          <option value="speechify">Speechify External TTS</option>
        </select>
        <div class="hint">
          Browser TTS = system voices. Speechify = external API (Snoop, etc., if your plan supports it).
        </div>

        <div id="browserTtsSettings" style="margin-top:14px;">
          <label>Kick Voice (Browser)</label>
          <select id="kickVoice" data-testid="kick-voice-select"></select>

          <label style="margin-top:10px;display:block">Timer Voice (Browser)</label>
          <select id="timerVoice" data-testid="timer-voice-select"></select>

          <label style="margin-top:10px;display:block">Volume</label>
          <input type="range" id="volume" min="0" max="1" step="0.01" value="1" data-testid="volume-slider">

          <label style="margin-top:10px;display:block">Rate</label>
          <input type="range" id="rate" min="0.5" max="2" step="0.01" value="1" data-testid="rate-slider">

          <label style="margin-top:10px;display:block">Pitch</label>
          <input type="range" id="pitch" min="0.5" max="2" step="0.01" value="1" data-testid="pitch-slider">
        </div>

        <div id="speechifySettings" style="margin-top:18px; display:none;">
          <h3 style="margin:0 0 8px 0;">Speechify Settings</h3>

          <label>Speechify API Key</label>
          <input type="password" id="speechifyApiKeyInput" placeholder="Paste your Speechify API key" data-testid="speechify-api-key-input">

          <label style="margin-top:10px;">Speechify Voice ID</label>
          <input type="text" id="speechifyVoiceIdInput" placeholder="Will update when you pick from dropdown" data-testid="speechify-voice-id-input">

          <div class="hint">
            You must have a Speechify account and a valid voice_id. This app will call their API directly.
          </div>

          <!-- Auto-load voices UI -->
          <button id="speechifyLoadVoicesBtn" style="margin-top:10px;" data-testid="speechify-load-voices-btn">Load Speechify Voices</button>
          <select id="speechifyVoiceDropdown" style="margin-top:10px; width:100%;" data-testid="speechify-voice-dropdown"></select>

          <button id="speechifyTestBtn" style="margin-top:10px;" data-testid="speechify-test-btn">Test Speechify Voice</button>
          <p id="speechifyStatus" style="font-size:12px; margin-top:6px; opacity:0.8;" data-testid="speechify-status"></p>
        </div>
      </div>
    </div>

    <!-- CHAT TAB -->
    <div id="tab-chat" class="tab-panel">
      <div class="panel">
        <h2>Chat Feed</h2>
        <div id="chatLog" data-testid="chat-log"></div>
      </div>
    </div>

    <!-- KEYWORDS TAB -->
    <div id="tab-keywords" class="tab-panel">
      <div class="panel">
        <h2>Keywords Filter</h2>
        <div class="hint" style="margin-bottom:12px;">
          When enabled, only messages containing at least one keyword will be read aloud.
        </div>

        <div style="margin-bottom:16px;">
          <label>
            <input type="checkbox" id="keywordsEnabled" data-testid="keywords-enabled-checkbox" />
            Enable Keywords Filter
          </label>
          <span id="keywordsStatusPill" class="status-pill status-off" data-testid="keywords-status-pill">Disabled</span>
        </div>

        <div>
          <label>Add Keyword</label>
          <input type="text" id="keywordInput" placeholder="Enter a keyword" data-testid="keyword-input">
          
          <div class="keyword-toggle-row">
            <label>
              <input type="checkbox" id="keywordCaseSensitive" data-testid="keyword-case-sensitive-checkbox" />
              Case-Sensitive
            </label>
          </div>

          <button id="addKeywordBtn" style="margin-top:10px;" data-testid="add-keyword-btn">Add Keyword</button>
          <p id="keywordError" style="color:#ff7a18; font-size:12px; margin-top:6px;" data-testid="keyword-error"></p>
        </div>

        <div style="margin-top:16px;">
          <h3 style="margin:0 0 8px 0; font-size:16px;">Active Keywords (<span id="keywordsCount" data-testid="keywords-count">0</span>)</h3>
          <div id="keywordsList" data-testid="keywords-list"></div>
          <p id="noKeywordsMsg" style="font-size:13px; opacity:0.7;" data-testid="no-keywords-msg">No keywords added yet. Add keywords above to filter messages.</p>
        </div>
      </div>
    </div>

    <!-- TIMERS TAB -->
    <div id="tab-timers" class="tab-panel">
      <div class="panel">
        <h2>Timers (up to 15)</h2>

        <div>
          <label>Timer Message</label>
          <input type="text" id="timerMessageInput" placeholder="What should this timer say?" data-testid="timer-message-input">

          <label style="margin-top:10px;display:block">Interval Preset</label>
          <select id="timerPresetSelect" data-testid="timer-preset-select">
            <option value="30">30 seconds</option>
            <option value="60">1 minute</option>
            <option value="120">2 minutes</option>
            <option value="300">5 minutes</option>
            <option value="600">10 minutes</option>
            <option value="900">15 minutes</option>
            <option value="custom">Custom (seconds)</option>
          </select>

          <div id="customIntervalWrapper" style="display:none; margin-top:8px;">
            <label>Custom Interval (seconds)</label>
            <input type="number" id="customIntervalInput" min="1" value="60" data-testid="custom-interval-input">
          </div>

          <button id="addTimerBtn" style="margin-top:10px;" data-testid="add-timer-btn">Add Timer</button>
          <p id="timerError" style="color:#ff7a18; font-size:12px; margin-top:6px;" data-testid="timer-error"></p>
        </div>

        <div style="margin-top:16px;">
          <h3 style="margin:0 0 8px 0; font-size:16px;">Active Timers</h3>
          <div id="timersList" data-testid="timers-list"></div>
        </div>
      </div>
    </div>

    <!-- CONNECTIONS TAB -->
    <div id="tab-connections" class="tab-panel">
      <div class="panel">
        <h2>Connections</h2>

        <h3 style="margin-top:0;">Kick</h3>
        <label>Kick Username</label>
        <input type="text" id="kickUsernameInput" value="justquitbro7" data-testid="kick-username-input">

        <div style="margin-top:8px;">
          <label>
            <input type="checkbox" id="kickEnableCheckbox" checked disabled data-testid="kick-enable-checkbox" />
            Enable Kick (static for now)
          </label>
          <span id="kickStatusPill" class="status-pill status-on" data-testid="kick-status-pill">Connected (auto)</span>
        </div>

        <hr style="margin:16px 0; border-color:rgba(255,255,255,0.2);">

        <h3>Twitch</h3>
        <label>Twitch Username</label>
        <input type="text" id="twitchUsernameInput" value="justquitbro7" data-testid="twitch-username-input">

        <label style="margin-top:8px;">Twitch OAuth Token (future use)</label>
        <input type="password" id="twitchTokenInput" placeholder="Not used yet" data-testid="twitch-token-input">

        <div style="margin-top:8px;">
          <label>
            <input type="checkbox" id="twitchEnableCheckbox" data-testid="twitch-enable-checkbox" />
            Enable Twitch (UI only for now)
          </label>
          <span id="twitchStatusPill" class="status-pill status-off" data-testid="twitch-status-pill">Disabled</span>
        </div>

        <p style="margin-top:12px; font-size:12px; opacity:0.8;">
          For now, Kick is connected automatically using the static username above.
          Twitch controls are UI-only until we wire in the actual connection.
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Audio element for Speechify playback -->
<audio id="speechifyAudio"></audio>

<script>
/* ====== CONFIG / STATE ====== */
const KICK_CHANNEL = "justquitbro7";

let queue = [];
let isPlaying = true;
let isMuted = false;
let isSpeaking = false;
let audioEnabled = false;

let voices = [];
let kickVoiceName = "";
let timerVoiceName = "";
let volume = 1;
let rate = 1;
let pitch = 1;

let timers = []; // up to 15

// TTS engine: "browser" or "speechify"
let ttsEngine = "browser";

// Speechify config (from UI)
let speechifyApiKey = "";
let speechifyVoiceId = "";

// Keywords config
let keywords = []; // { id, text, caseSensitive }
let keywordsEnabled = false;

/* ====== ELEMENTS ====== */
const queueLen = document.getElementById("queueLen");
const speakingNow = document.getElementById("speakingNow");
const chatLog = document.getElementById("chatLog");

const enableAudioBtn = document.getElementById("enableAudioBtn");
const playPauseBtn = document.getElementById("playPauseBtn");
const muteBtn = document.getElementById("muteBtn");
const testTtsBtn = document.getElementById("testTtsBtn");
const testTimerBtn = document.getElementById("testTimerBtn");
const readUsernameBox = document.getElementById("readUsername");

const kickVoiceSelect = document.getElementById("kickVoice");
const timerVoiceSelect = document.getElementById("timerVoice");
const volumeSlider = document.getElementById("volume");
const rateSlider = document.getElementById("rate");
const pitchSlider = document.getElementById("pitch");

const ttsEngineSelect = document.getElementById("ttsEngineSelect");
const browserTtsSettings = document.getElementById("browserTtsSettings");
const speechifySettings = document.getElementById("speechifySettings");
const speechifyApiKeyInput = document.getElementById("speechifyApiKeyInput");
const speechifyVoiceIdInput = document.getElementById("speechifyVoiceIdInput");
const speechifyLoadVoicesBtn = document.getElementById("speechifyLoadVoicesBtn");
const speechifyVoiceDropdown = document.getElementById("speechifyVoiceDropdown");
const speechifyTestBtn = document.getElementById("speechifyTestBtn");
const speechifyStatus = document.getElementById("speechifyStatus");
const speechifyAudio = document.getElementById("speechifyAudio");

const timerMessageInput = document.getElementById("timerMessageInput");
const timerPresetSelect = document.getElementById("timerPresetSelect");
const customIntervalWrapper = document.getElementById("customIntervalWrapper");
const customIntervalInput = document.getElementById("customIntervalInput");
const addTimerBtn = document.getElementById("addTimerBtn");
const timersList = document.getElementById("timersList");
const timerError = document.getElementById("timerError");

const kickUsernameInput = document.getElementById("kickUsernameInput");
const kickStatusPill = document.getElementById("kickStatusPill");
const twitchUsernameInput = document.getElementById("twitchUsernameInput");
const twitchEnableCheckbox = document.getElementById("twitchEnableCheckbox");
const twitchStatusPill = document.getElementById("twitchStatusPill");

// Keywords elements
const keywordsEnabledCheckbox = document.getElementById("keywordsEnabled");
const keywordsStatusPill = document.getElementById("keywordsStatusPill");
const keywordInput = document.getElementById("keywordInput");
const keywordCaseSensitiveCheckbox = document.getElementById("keywordCaseSensitive");
const addKeywordBtn = document.getElementById("addKeywordBtn");
const keywordsList = document.getElementById("keywordsList");
const keywordError = document.getElementById("keywordError");
const keywordsCount = document.getElementById("keywordsCount");
const noKeywordsMsg = document.getElementById("noKeywordsMsg");

/* ====== SIDEBAR TABS ====== */
document.querySelectorAll(".tab-button").forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
    document.querySelectorAll(".tab-panel").forEach(p => p.classList.remove("active"));

    btn.classList.add("active");
    const targetId = btn.getAttribute("data-target");
    const panel = document.getElementById(targetId);
    if (panel) panel.classList.add("active");
  };
});

/* ====== VOICES (BROWSER TTS) ====== */
function loadVoices() {
  voices = speechSynthesis.getVoices();
  if (voices.length === 0) {
    setTimeout(loadVoices, 200);
    return;
  }

  kickVoiceSelect.innerHTML = "";
  timerVoiceSelect.innerHTML = "";

  voices.forEach(v => {
    const opt1 = document.createElement("option");
    opt1.value = v.name;
    opt1.textContent = v.name;
    kickVoiceSelect.appendChild(opt1);

    const opt2 = document.createElement("option");
    opt2.value = v.name;
    opt2.textContent = v.name;
    timerVoiceSelect.appendChild(opt2);
  });

  if (!kickVoiceName) kickVoiceName = voices[0].name;
  if (!timerVoiceName) timerVoiceName = voices[1]?.name || voices[0].name;

  kickVoiceSelect.value = kickVoiceName;
  timerVoiceSelect.value = timerVoiceName;
}

speechSynthesis.onvoiceschanged = loadVoices;
loadVoices();

/* ====== KICK CONNECTION (STATIC USERNAME FOR NOW) ====== */
async function connectKick() {
  try {
    const res = await fetch(`https://kick.com/api/v2/channels/${KICK_CHANNEL}`);
    const data = await res.json();
    const chatroomId = data.chatroom?.id;

    const ws = new WebSocket(
      "wss://ws-us2.pusher.com/app/32cbd69e4b950bf97679?protocol=7&client=js&version=8.4.0-rc2&flash=false"
    );

    ws.onmessage = (event) => {
      const msg = JSON.parse(event.data);

      if (msg.event === "pusher:connection_established") {
        ws.send(JSON.stringify({
          event: "pusher:subscribe",
          data: { channel: `chatrooms.${chatroomId}.v2` }
        }));
      }

      if (msg.event === "App\\Events\\ChatMessageEvent") {
        const payload = JSON.parse(msg.data);
        const username = payload.sender?.username || "Unknown";
        const messageId = payload.id || Date.now() + "-" + Math.random();
        const text = payload.content || "";

        addMessage({
          platform: "kick",
          username,
          message: text,
          id: "kick-" + messageId
        });
      }
    };

    ws.onclose = () => setTimeout(connectKick, 5000);

  } catch (err) {
    setTimeout(connectKick, 10000);
  }
}

connectKick();

/* ====== KEYWORDS FUNCTIONS ====== */
function messageMatchesKeywords(message) {
  if (!keywordsEnabled || keywords.length === 0) {
    return true; // If keywords disabled or no keywords, allow all
  }

  for (const kw of keywords) {
    if (kw.caseSensitive) {
      if (message.includes(kw.text)) return true;
    } else {
      if (message.toLowerCase().includes(kw.text.toLowerCase())) return true;
    }
  }

  return false;
}

function renderKeywords() {
  keywordsList.innerHTML = "";
  keywordsCount.textContent = keywords.length;

  if (keywords.length === 0) {
    noKeywordsMsg.style.display = "block";
  } else {
    noKeywordsMsg.style.display = "none";
  }

  keywords.forEach(kw => {
    const div = document.createElement("div");
    div.className = "keyword-item";
    div.setAttribute("data-testid", `keyword-item-${kw.id}`);

    div.innerHTML = `
      <div>
        <span class="keyword-text">${escapeHtml(kw.text)}</span>
        <div class="keyword-meta">${kw.caseSensitive ? "Case-Sensitive" : "Case-Insensitive"}</div>
      </div>
      <div class="keyword-actions">
        <button data-id="${kw.id}" class="toggleCaseBtn" data-testid="toggle-case-${kw.id}">
          ${kw.caseSensitive ? "Make Insensitive" : "Make Sensitive"}
        </button>
        <button data-id="${kw.id}" class="deleteKeywordBtn" data-testid="delete-keyword-${kw.id}">
          Delete
        </button>
      </div>
    `;

    keywordsList.appendChild(div);
  });

  // Attach event listeners
  document.querySelectorAll(".toggleCaseBtn").forEach(btn => {
    btn.onclick = () => {
      const id = btn.getAttribute("data-id");
      const kw = keywords.find(k => k.id === id);
      if (kw) {
        kw.caseSensitive = !kw.caseSensitive;
        renderKeywords();
      }
    };
  });

  document.querySelectorAll(".deleteKeywordBtn").forEach(btn => {
    btn.onclick = () => {
      const id = btn.getAttribute("data-id");
      keywords = keywords.filter(k => k.id !== id);
      renderKeywords();
    };
  });
}

function escapeHtml(text) {
  const div = document.createElement("div");
  div.textContent = text;
  return div.innerHTML;
}

function addKeywordFromUI() {
  keywordError.textContent = "";

  const text = (keywordInput.value || "").trim();
  if (!text) {
    keywordError.textContent = "Please enter a keyword.";
    return;
  }

  // Check for duplicates
  const duplicate = keywords.find(kw => 
    kw.text.toLowerCase() === text.toLowerCase()
  );
  if (duplicate) {
    keywordError.textContent = "This keyword already exists.";
    return;
  }

  const kw = {
    id: "kw-" + Date.now() + "-" + Math.random(),
    text: text,
    caseSensitive: keywordCaseSensitiveCheckbox.checked
  };

  keywords.push(kw);
  keywordInput.value = "";
  keywordCaseSensitiveCheckbox.checked = false;
  renderKeywords();
}

addKeywordBtn.onclick = addKeywordFromUI;

// Allow Enter key to add keyword
keywordInput.addEventListener("keypress", (e) => {
  if (e.key === "Enter") {
    addKeywordFromUI();
  }
});

keywordsEnabledCheckbox.onchange = () => {
  keywordsEnabled = keywordsEnabledCheckbox.checked;
  if (keywordsEnabled) {
    keywordsStatusPill.textContent = "Enabled";
    keywordsStatusPill.classList.remove("status-off");
    keywordsStatusPill.classList.add("status-on");
  } else {
    keywordsStatusPill.textContent = "Disabled";
    keywordsStatusPill.classList.remove("status-on");
    keywordsStatusPill.classList.add("status-off");
  }
};

// Initialize keywords UI
renderKeywords();

/* ====== CHAT / QUEUE ====== */
function addMessage(msg) {
  // Always show in chat log
  const div = document.createElement("div");
  div.className = "chat-line";
  const color = msg.platform === "kick" ? "#53fc18" : "#ff7a18";
  div.innerHTML = `<span style="color:${color};font-weight:600">[${msg.platform}] ${msg.username}:</span> ${msg.message}`;
  chatLog.appendChild(div);
  chatLog.scrollTop = chatLog.scrollHeight;

  // Only add to TTS queue if message matches keywords (or keywords disabled)
  if (messageMatchesKeywords(msg.message)) {
    queue.push(msg);
    queueLen.textContent = queue.length;
  }
}

/* ====== SPEECHIFY HELPER ====== */
async function speakWithSpeechify(text) {
  if (!speechifyApiKey || !speechifyVoiceId) {
    console.warn("Speechify missing API key or voice ID");
    return false;
  }

  try {
    const res = await fetch("https://api.sws.speechify.com/v1/audio/speech", {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + speechifyApiKey,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        voice_id: speechifyVoiceId,
        text: text,
        audio_format: "mp3"
      })
    });

    if (!res.ok) {
      console.error("Speechify error:", res.status, await res.text());
      return false;
    }

    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    speechifyAudio.src = url;

    return new Promise((resolve) => {
      speechifyAudio.onended = () => {
        URL.revokeObjectURL(url);
        resolve(true);
      };
      speechifyAudio.onerror = () => {
        URL.revokeObjectURL(url);
        resolve(false);
      };
      speechifyAudio.play().catch(() => resolve(false));
    });
  } catch (e) {
    console.error("Speechify exception:", e);
    return false;
  }
}

/* ====== SPEECHIFY VOICE AUTO-LOADER ====== */
speechifyLoadVoicesBtn.onclick = async () => {
  const key = speechifyApiKeyInput.value.trim();
  if (!key) {
    speechifyStatus.textContent = "Enter your API key first.";
    return;
  }

  speechifyStatus.textContent = "Loading voices...";

  try {
    const res = await fetch("https://api.sws.speechify.com/v1/voices", {
      headers: {
        "Authorization": "Bearer " + key
      }
    });

    if (!res.ok) {
      speechifyStatus.textContent = "Failed to load voices. Check API key.";
      return;
    }

    const voices = await res.json();
    speechifyVoiceDropdown.innerHTML = "";

    voices.forEach(v => {
      const opt = document.createElement("option");
      opt.value = v.voice_id;
      opt.textContent = v.name || v.voice_id;
      speechifyVoiceDropdown.appendChild(opt);
    });

    speechifyStatus.textContent = "Voices loaded.";

    // Set initial selection and update voice_id
    if (voices.length > 0) {
      speechifyVoiceDropdown.value = voices[0].voice_id;
      speechifyVoiceIdInput.value = voices[0].voice_id;
      speechifyVoiceId = voices[0].voice_id;
    }

  } catch (err) {
    speechifyStatus.textContent = "Error loading voices.";
    console.error(err);
  }
};

speechifyVoiceDropdown.onchange = () => {
  speechifyVoiceIdInput.value = speechifyVoiceDropdown.value;
  speechifyVoiceId = speechifyVoiceDropdown.value;
};

/* ====== TTS LOOP (ENGINE SWITCH) ====== */
setInterval(async () => {
  if (!audioEnabled || !isPlaying || isMuted || isSpeaking || queue.length === 0) return;

  const next = queue.shift();
  queueLen.textContent = queue.length;

  const text = readUsernameBox.checked
    ? `${next.username} says: ${next.message}`
    : next.message;

  isSpeaking = true;
  speakingNow.textContent = `${next.username}: ${next.message}`;

  if (ttsEngine === "speechify") {
    const ok = await speakWithSpeechify(text);
    isSpeaking = false;
    speakingNow.textContent = "None";
    if (!ok) {
      // fallback to browser TTS if Speechify fails
      const utter = new SpeechSynthesisUtterance(text);
      utter.volume = volume;
      utter.rate = rate;
      utter.pitch = pitch;
      const voiceName = next.platform === "kick" ? kickVoiceName : timerVoiceName;
      const voice = voices.find(v => v.name === voiceName);
      if (voice) utter.voice = voice;
      utter.onend = () => {
        isSpeaking = false;
        speakingNow.textContent = "None";
      };
      speechSynthesis.cancel();
      speechSynthesis.speak(utter);
    }
  } else {
    const utter = new SpeechSynthesisUtterance(text);
    utter.volume = volume;
    utter.rate = rate;
    utter.pitch = pitch;
    const voiceName = next.platform === "kick" ? kickVoiceName : timerVoiceName;
    const voice = voices.find(v => v.name === voiceName);
    if (voice) utter.voice = voice;
    utter.onend = () => {
      isSpeaking = false;
      speakingNow.textContent = "None";
    };
    speechSynthesis.cancel();
    speechSynthesis.speak(utter);
  }
}, 100);

/* ====== MULTI TIMER (UP TO 15) ====== */
function renderTimers() {
  timersList.innerHTML = "";
  timers.forEach(t => {
    const div = document.createElement("div");
    div.className = "timer-item";

    const intervalSec = Math.round(t.intervalMs / 1000);

    div.innerHTML = `
      <div><strong style="color:#ff7a18;">${t.message}</strong></div>
      <div class="timer-meta">
        Every ${intervalSec} seconds<br>
        Last fired: ${t.lastFired ? new Date(t.lastFired).toLocaleTimeString() : "Never"}
      </div>
      <div style="margin-top:6px;">
        <button data-id="${t.id}" class="toggleTimerBtn">
          ${t.enabled ? "Disable" : "Enable"}
        </button>
        <button data-id="${t.id}" class="deleteTimerBtn">
          Delete
        </button>
      </div>
    `;

    timersList.appendChild(div);
  });

  document.querySelectorAll(".toggleTimerBtn").forEach(btn => {
    btn.onclick = () => {
      const id = btn.getAttribute("data-id");
      const timer = timers.find(t => t.id === id);
      if (!timer) return;
      timer.enabled = !timer.enabled;
      renderTimers();
    };
  });

  document.querySelectorAll(".deleteTimerBtn").forEach(btn => {
    btn.onclick = () => {
      const id = btn.getAttribute("data-id");
      timers = timers.filter(t => t.id !== id);
      renderTimers();
    };
  });
}

function addTimerFromUI() {
  timerError.textContent = "";

  if (timers.length >= 15) {
    timerError.textContent = "You already have 15 timers. Delete one to add another.";
    return;
  }

  const msg = (timerMessageInput.value || "").trim();
  if (!msg) {
    timerError.textContent = "Please enter a timer message.";
    return;
  }

  let intervalSec;
  const preset = timerPresetSelect.value;
  if (preset === "custom") {
    const custom = parseInt(customIntervalInput.value, 10);
    if (isNaN(custom) || custom <= 0) {
      timerError.textContent = "Custom interval must be a positive number of seconds.";
      return;
    }
    intervalSec = custom;
  } else {
    intervalSec = parseInt(preset, 10);
  }

  const timer = {
    id: "timer-" + Date.now() + "-" + Math.random(),
    message: msg,
    intervalMs: intervalSec * 1000,
    enabled: true,
    lastFired: 0
  };

  timers.push(timer);
  timerMessageInput.value = "";
  renderTimers();
}

timerPresetSelect.onchange = () => {
  if (timerPresetSelect.value === "custom") {
    customIntervalWrapper.style.display = "block";
  } else {
    customIntervalWrapper.style.display = "none";
  }
};

addTimerBtn.onclick = addTimerFromUI;

setInterval(() => {
  const now = Date.now();
  timers.forEach(t => {
    if (!t.enabled) return;
    if (!t.lastFired || now - t.lastFired >= t.intervalMs) {
      t.lastFired = now;
      addMessage({
        platform: "timer",
        username: "Timer",
        message: t.message,
        id: t.id + "-" + now
      });
    }
  });
  renderTimers();
}, 500);

/* ====== CONNECTIONS UI (STATIC FOR NOW) ====== */
twitchEnableCheckbox.onchange = () => {
  if (twitchEnableCheckbox.checked) {
    twitchStatusPill.textContent = "Enabled (UI only)";
    twitchStatusPill.classList.remove("status-off");
    twitchStatusPill.classList.add("status-on");
  } else {
    twitchStatusPill.textContent = "Disabled";
    twitchStatusPill.classList.remove("status-on");
    twitchStatusPill.classList.add("status-off");
  }
};

/* ====== TTS ENGINE UI ====== */
ttsEngineSelect.onchange = () => {
  ttsEngine = ttsEngineSelect.value;
  if (ttsEngine === "speechify") {
    browserTtsSettings.style.display = "none";
    speechifySettings.style.display = "block";
  } else {
    browserTtsSettings.style.display = "block";
    speechifySettings.style.display = "none";
  }
};

speechifyApiKeyInput.oninput = () => {
  speechifyApiKey = speechifyApiKeyInput.value.trim();
};

speechifyVoiceIdInput.oninput = () => {
  speechifyVoiceId = speechifyVoiceIdInput.value.trim();
};

speechifyTestBtn.onclick = async () => {
  speechifyStatus.textContent = "Testing Speechify voice...";
  const ok = await speakWithSpeechify("This is a Speechify test from Jailex HUD.");
  speechifyStatus.textContent = ok
    ? "Speechify test played successfully."
    : "Speechify test failed. Check API key, voice ID, or console.";
};

/* ====== UI EVENTS ====== */
enableAudioBtn.onclick = () => {
  audioEnabled = true;
  const starter = new SpeechSynthesisUtterance(" ");
  speechSynthesis.speak(starter);
  const u = new SpeechSynthesisUtterance("Audio enabled.");
  speechSynthesis.speak(u);
};

playPauseBtn.onclick = () => {
  isPlaying = !isPlaying;
  playPauseBtn.textContent = isPlaying ? "Pause" : "Play";
};

muteBtn.onclick = () => {
  isMuted = !isMuted;
  muteBtn.textContent = isMuted ? "Unmute" : "Mute";
};

testTtsBtn.onclick = () => {
  if (!audioEnabled) return alert("Enable audio first.");
  addMessage({
    platform: "timer",
    username: "System",
    message: "This is a Jailex TTS test.",
    id: "test-" + Date.now()
  });
};

testTimerBtn.onclick = () => {
  addMessage({
    platform: "timer",
    username: "Timer",
    message: "Timer event fired.",
    id: "timer-" + Date.now()
  });
};

kickVoiceSelect.onchange = () => kickVoiceName = kickVoiceSelect.value;
timerVoiceSelect.onchange = () => timerVoiceName = timerVoiceSelect.value;

volumeSlider.oninput = () => volume = parseFloat(volumeSlider.value);
rateSlider.oninput = () => rate = parseFloat(rateSlider.value);
pitchSlider.oninput = () => pitch = parseFloat(pitchSlider.value);
</script>

</body>
</html>
